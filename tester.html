<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>HTML</title>
    <style>
      /*#snippet {
      position: relative;
      width:calc(30% - 10px);
      margin: 5px;
      background-color: white;
      height:86.4%;
      color: black;
      box-sizing: border-box;
      }*/
      #center {
      margin: 5px;
      width: calc(100%);
      height:86.4%;
      }
    </style>
  </head>
  <body>
    <div id="center"></div>



                          <li class="dropdown">
                            <a data-toggle="dropdown" href="" aria-expanded="false"><i class="tm-icon zmdi zmdi-more-vert"></i></a>
                            <ul class="dropdown-menu dm-icon pull-right">
                                <li class="skin-switch hidden-xs">
                                    <span class="ss-skin bgm-lightblue" data-skin="lightblue"></span>
                                    <span class="ss-skin bgm-bluegray" data-skin="bluegray"></span>
                                    <span class="ss-skin bgm-cyan" data-skin="cyan"></span>
                                    <span class="ss-skin bgm-teal" data-skin="teal"></span>
                                    <span class="ss-skin bgm-orange" data-skin="orange"></span>
                                    <span class="ss-skin bgm-blue" data-skin="blue"></span>
                                </li>
                                <li class="divider hidden-xs"></li>
                                <li class="hidden-xs">
                                    <a data-action="fullscreen" href=""><i class="zmdi zmdi-fullscreen"></i> Toggle Fullscreen</a>
                                </li>
                                <li>
                                    <a data-action="clear-localstorage" href=""><i class="zmdi zmdi-delete"></i> Clear Local Storage</a>
                                </li>
                                <li>
                                    <a href=""><i class="zmdi zmdi-face"></i> Privacy Settings</a>
                                </li>
                                <li>
                                    <a href=""><i class="zmdi zmdi-settings"></i> Other Settings</a>
                                </li>
                            </ul>
                        </li>



    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.6/ace.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
          var editor = ace.edit("center");
          editor.setTheme("ace/theme/cobalt");
          editor.getSession().setMode("ace/mode/python");

          var listening = false

          var socket = io();

           socket.on('reply', function(data){
            document.getElementById("snippet").innerHTML += data.response + '<br>';
           });

           socket.on('opened', function(data){
            editor.setValue(data.file, -1)
            editor.navigateFileEnd()
           });

           socket.on('executionresults', function(data){
            document.getElementById("terminal").innerHTML += data.response + '<br>';
           });

           socket.on('welcome', function(data){
            document.getElementById("snippet").innerHTML += data.message + '<br>';
           });

           socket.on('downloadableFile', function(data){
            var elem = document.createElement('a');
            elem.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(data.content));
            elem.setAttribute('download', data.name+ ".py");
            elem.style.display = 'none';
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(element);
           });

           

          var compiler = function(data, editor){

            var messages = data.split(" ");

            for (i = 0; i < messages.length; i++){
              if ((messages[i] == 'buggy') && ((i + 2) < messages.length)){
                if ((messages[i+1] == "start") && (messages[i+2] == 'listening')){
                  listening = true;
                  break;
                }
                else if ((messages[i+1] == "stop") && (messages[i+2] == 'listening')){
                  listening = false;
                  break;
                }
                else if (messages[i+1] == "search") {
                  var query = "";
                  for (j = i + 1; j < messages.length; j++){
                    query += messages[j] + ' ';
                  }
                  document.getElementById("snippet").innerHTML+=query + '<br>';
                  socket.emit('search', {message: query});
                  break;
                }
                else if ((messages[i+1] == "please") && (messages[i+2] == "run")) {
                  var text = editor.getValue();
                  document.getElementById("terminal").innerHTML += "Executing code:" + '<br>';
                  socket.emit('execute', {message: text});
                  break;
                }
                else if ((((messages[i+1] == "save") && (messages[i+2] == 'file')) && (messages[i+3] == 'as')) && (messages.length >= 5)) {
                  var fileContent = editor.getValue();
                  var filename = messages[i+4]
                  var user = "luffy"
                  socket.emit('saveFile', {content: fileContent, username: user, name: filename});
                  break;
                }
                else if ((((messages[i+1] == "delete") && (messages[i+2] == 'file')) && (messages[i+3] == 'named')) && (messages.length >= 5)) {
                  var filename = messages[i+4]
                  var user = "luffy"
                  socket.emit('deleteFile', {username: user, name: filename});
                  break;
                }
                else if ((((messages[i+1] == "download") && (messages[i+2] == 'file')) && (messages[i+3] == 'named')) && (messages.length >= 5)) {
                  var filename = messages[i+4]
                  var user = "luffy"
                  socket.emit('download', {username: user, name: filename});
                  break;
                }
                else if ((((messages[i+1] == "open") && (messages[i+2] == 'file')) && (messages[i+3] == 'named')) && (messages.length >= 5)) {
                  var filename = messages[i+4]
                  var user = "luffy"
                  socket.emit('open', {username: user, name: filename});
                  break;
                }
              }
              if (listening){
                if (messages[i] == "quote"){
                  editor.insert("\"");
                }
                else if (messages[i] == "Focus") {
                  editor.focus();
                  }
                else if (messages[i] == "star") {
                  editor.insert("*");
                }
                else if (messages[i] == "pound") {
                  editor.insert("#");
                }
                else if (messages[i] == "comma") {
                  editor.insert(",");
                }
                else if ((messages[i] == "new") || (messages[i] == "\n")) {
                  editor.insert("\n");
                }
                else if (messages[i] == "space"){
                  editor.insert(" ");
                }
                else if (messages[i] == "delete"){
                  editor.removeWordLeft();
                }
                else if (messages[i] == "clear") {
                  editor.removeToLineStart();
                }
                else if (messages[i] == "reset") {
                  editor.selectAll();
                  editor.removeLines();
                }
                else if ( (messages[i] == "move") || (messages[i] == "go") ) {       
                   if ((messages[i+1] == "upwards") || (messages[i+1] == "up")) {
                      editor.navigateUp(1);
                      i++;
                    }
                    else if ((messages[i+1] == "downwards") || (messages[i+1] == "down")){
                      editor.navigateDown(1);
                      i++;
                   }
                   else if (messages[i+1] == "left") {
                      editor.navigateWordLeft();
                      i++;
                   }
                   else if (messages[i+1] == "right") {
                      editor.navigateWordRight();
                      i++;
                   }
                   else if (messages[i+1] == "to") {
                      if (messages[i+2] == "start") {
                        editor.navigateFileStart();
                        i++;
                      }
                      else if (messages[i+2] == "end") {
                        editor.navigateFileEnd();
                        i++;
                      }
                      else if (messages[i+2] == "front") {
                        editor.navigateLineStart();
                        i++;
                      }
                      else if (messages[i+2] == "back") {
                        editor.navigateLineEnd();
                        i++;
                      }
                      else {
                        editor.insert("move to ");
                      }
                      i++;
                    }
                   else {
                      editor.insert(messages[i]+" ");
                    }
                  }
                else if (messages[i] == "left") {
                   if (messages[i+1] == "curly") {
                      editor.insert("{");
                      i++;
                    }
                    else if (messages[i+1] == "paren") {
                      editor.insert("(");
                      i++;
                    }
                   else if (messages[i+1] == "bracket") {
                      editor.insert("[");
                      i++;
                   }
                  else {
                      editor.insert(messages[i]+' ');
                    }
                }
                else if (messages[i] == "right") {
                   if (messages[i+1] == "curly") {
                      editor.insert("}");
                      i++;
                    }
                    else if (messages[i+1] == "paren") {
                      editor.insert(")");
                      i++;
                   }
                   else if (messages[i+1] == "bracket") {
                      editor.insert("]");
                      i++;
                    }
                    else {
                      editor.insert(messages[i]+' ');
                    }
                }
                else{
                  editor.insert(messages[i]+' ');
                }
              }
            }
          }


          if (!('webkitSpeechRecognition' in window)) {
            upgrade();
          } else {
            var recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.onerror = function(event) { console.log("oops") }
            recognition.onend = function() { recognition.start() }
            recognition.onresult = function(event) {
            compiler(event.results[0][0].transcript, editor);
          };
        }
          console.log("Hello World")
          recognition.start()
    </script>
  </body>
</html>